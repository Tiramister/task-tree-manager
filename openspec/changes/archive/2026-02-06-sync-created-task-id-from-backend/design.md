## Context

現在の同期仕様では、ログイン済みユーザーのタスク作成時に `POST /tasks` をバックグラウンド送信するが、フロントエンドに一時 ID で追加したタスクをバックエンド採番 ID に置き換える要件が明確でない。結果として、作成直後タスクの ID がフロントエンドとバックエンドで不一致になり、後続の更新・削除・並べ替え時に対象 ID がずれるリスクがある。

## Goals / Non-Goals

**Goals:**
- タスク作成成功時に、該当タスクの ID をバックエンド採番 ID に確実に更新する。
- ID 置換後も、taskStore 内の親子関係・参照整合性を維持する。
- 既存方針（バックエンドレスポンスでの全体上書きをしない）を維持したまま、作成対象タスクのみ最小更新する。

**Non-Goals:**
- ログイン時初期同期ロジック（`GET /tasks` 後の上書き戦略）の変更。
- `POST /tasks` API のレスポンス仕様変更。
- タスク ID 以外のフィールド更新ポリシー見直し。

## Decisions

1. 作成直後タスクと `POST /tasks` レスポンスを紐付けるため、作成処理に「ローカル暫定 ID」を保持し、レスポンス受信時にその ID をキーに taskStore の対象タスクを特定して ID を置換する。
- 理由: レスポンス反映対象を単一タスクに限定でき、全体再取得を避けられる。
- 代替案: `POST /tasks` 成功のたびに `GET /tasks` で全件再取得して上書きする。
- 不採用理由: 通信コスト増加と UI ちらつき、既存方針との不整合が生じる。

2. ID 置換は taskStore の専用更新処理で実装し、必要な関連参照（例: 一時 ID を参照する保留中の操作対象）があれば同一トランザクションで更新する。
- 理由: 複数箇所での個別更新を避け、整合性ルールを一元化できる。
- 代替案: 各利用箇所で都度 ID を差し替える。
- 不採用理由: 更新漏れが起きやすく、回帰を招く。

3. 反映は「作成成功時のみ」で行い、失敗時は既存のエラーハンドリング方針に従う。
- 理由: 本 change は ID 不一致の解消に集中し、失敗時 UX の拡張はスコープ外とする。
- 代替案: 失敗時にローカルタスクを自動ロールバックする。
- 不採用理由: 既存仕様変更が大きく、別 change で検討すべき。

## Risks / Trade-offs

- [リスク] レスポンス反映前にユーザーが連続操作すると、旧 ID を使った API 呼び出しが混在する可能性がある。→ Mitigation: 置換対象タスクの保留中操作がある場合は ID 置換後の ID を参照するよう、操作時の ID 取得点を store 最新値に統一する。
- [トレードオフ] 全件再取得より実装は複雑になる。→ Mitigation: ID 置換ロジックを小さな純粋関数と store 更新関数に分離し、単体テストで保証する。
- [リスク] 親子作成を短時間で連続実行した際に、親の一時 ID 参照が残る可能性がある。→ Mitigation: 親 ID を参照する作成処理は送信直前に最新 store から解決する。

## Migration Plan

1. `task-sync` 関連の仕様テストを追加し、作成成功時 ID 置換シナリオを先に固定する。
2. taskSyncService と taskStore に ID 置換処理を実装する。
3. ログイン済み作成フローの既存テストを更新し、更新・削除・並べ替えが新 ID で呼ばれることを確認する。
4. リリース後に API エラーログとクライアント操作エラーを監視し、ID 不一致由来の失敗が減少していることを確認する。

## Open Questions

- なし（現時点では既存 API レスポンスに作成済みタスク ID が含まれる前提で実装可能）。
