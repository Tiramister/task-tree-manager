## Context

バックエンドは Go 1.25 で実装されたシンプルな HTTP サーバーであり、現在は外部依存なし（標準ライブラリのみ）の状態である。データベースは存在せず、タスクデータはフロントエンドの localStorage にのみ保存されている。

ローカル開発環境は docker-compose.yml で frontend と backend の 2 サービスを管理している。バックエンドの Docker イメージは `distroless/static:nonroot` ベースのマルチステージビルドで構成されている。

## Goals / Non-Goals

**Goals:**

- Go バックエンドから PostgreSQL に接続できるようにする
- データベース接続情報を環境変数で設定できるようにする
- ローカル開発環境で PostgreSQL コンテナを使えるようにする
- マイグレーション管理ツールを導入し、スキーマ変更を追跡可能にする

**Non-Goals:**

- テーブル定義やアプリケーションのスキーマ設計（今回はマイグレーション基盤の導入まで）
- フロントエンドからバックエンド API へのデータ移行
- 本番環境のデータベース構築・デプロイ設定

## Decisions

### PostgreSQL ドライバ: pgx

Go の PostgreSQL ドライバとして `jackc/pgx` (v5) を採用する。

- **理由**: `lib/pq` はメンテナンスモードに入っており、`pgx` が事実上の標準になっている。`database/sql` インターフェースにも対応しており、将来的な柔軟性もある。
- **代替案**: `lib/pq` — 長年の実績があるが、新規プロジェクトでは `pgx` が推奨されている。

### マイグレーションツール: golang-migrate

マイグレーション管理ツールとして `golang-migrate/migrate` を採用する。

- **理由**: Go エコシステムで広く使われており、CLI ツールとライブラリの両方として利用可能。SQL ベースのマイグレーションファイルで、Up/Down の両方向をサポートする。Docker イメージも公式に提供されており、CI/CD への組み込みも容易。
- **代替案**:
  - `goose` — シンプルで使いやすいが、`golang-migrate` の方がエコシステムが大きい。
  - `atlas` — 宣言的なスキーマ管理が可能だが、学習コストが高い。

### 環境変数の設計

個別の環境変数で接続情報を管理する。

| 環境変数 | 説明 | デフォルト値 |
|----------|------|-------------|
| `DB_HOST` | データベースホスト | `localhost` |
| `DB_PORT` | データベースポート | `5432` |
| `DB_USER` | ユーザー名 | `postgres` |
| `DB_PASSWORD` | パスワード | (なし) |
| `DB_NAME` | データベース名 | `task_tree_manager` |
| `DB_SSLMODE` | SSL モード | `disable` |

- **理由**: `DATABASE_URL` 形式よりも個別の環境変数の方が、各設定値の管理・変更が容易であり、Docker Compose や AWS ECS などのインフラ設定とも相性が良い。
- **代替案**: `DATABASE_URL` 一括指定 — シンプルだが、個別設定の柔軟性に欠ける。

### ローカル PostgreSQL のポートマッピング

ローカル開発用の PostgreSQL コンテナは `5532:5432` でホストにマッピングする。

- **理由**: デフォルトポート `5432` はホストにインストールされた PostgreSQL と衝突する可能性があるため、`5532` を使用する。既存サービスのポートマッピング（frontend: `3521`, backend: `8521`）とも一貫性のある慣例（末尾を変える）を維持する。

### データの永続化

Docker の名前付きボリュームを使って PostgreSQL のデータを永続化する。

- **理由**: コンテナの再作成時にもデータが保持される。バインドマウントよりもポータブルで、Docker が管理するためパーミッションの問題が起きにくい。

## Risks / Trade-offs

- **distroless イメージとの互換性**: バックエンドの Docker イメージが `distroless/static:nonroot` ベースであり、シェルが含まれない。マイグレーションの実行は別コンテナまたはアプリケーション起動時に行う必要がある。→ マイグレーションは Go のアプリケーションコード内で実行する方式を採用する。
- **ローカル開発の依存関係増加**: PostgreSQL コンテナが必須になることで、バックエンドの単体起動が難しくなる。→ ただし、もともと docker-compose で管理しているため影響は限定的。
- **マイグレーションの自動実行**: アプリケーション起動時にマイグレーションを自動実行すると、複数インスタンス起動時に競合が起こりうる。→ 現時点では単一インスタンス前提のため問題ない。将来的にはマイグレーション専用のコマンドを分離する。
