## MODIFIED Requirements

### Requirement: 折り畳み状態の永続化

ログイン済みユーザーの場合、システムはタスクツリーの折り畳み状態をバックエンド（tasks テーブルの `is_collapsed` カラム）に永続化しなければならない（SHALL）。未ログインユーザーの場合は、localStorage に永続化しなければならない（SHALL）。

#### Scenario: ログイン済みユーザーの折り畳み操作時の自動保存

- **WHEN** ログイン済みユーザーがタスクの折り畳み/展開を操作する
- **THEN** 折り畳み状態が即座に `PATCH /tasks/{id}` でバックエンドに保存される

#### Scenario: 未ログインユーザーの折り畳み操作時の自動保存

- **WHEN** 未ログインユーザーがタスクの折り畳み/展開を操作する
- **THEN** 折り畳み状態が即座に localStorage に保存される

#### Scenario: 一括折り畳み操作時の自動保存（ログイン済み）

- **WHEN** ログイン済みユーザーが「全て折り畳む」または「全て展開」を操作する
- **THEN** 対象タスクの折り畳み状態がそれぞれ `PATCH /tasks/{id}` でバックエンドに保存される

#### Scenario: 一括折り畳み操作時の自動保存（未ログイン）

- **WHEN** 未ログインユーザーが「全て折り畳む」または「全て展開」を操作する
- **THEN** 折り畳み状態が即座に localStorage に保存される

### Requirement: 折り畳み状態の復元

ログイン済みユーザーの場合、システムはログイン時またはページリロード時にバックエンドから取得したタスクデータの折り畳み状態を復元しなければならない（SHALL）。未ログインユーザーの場合は、localStorage から復元しなければならない（SHALL）。

#### Scenario: ログイン済みユーザーの保存済み状態の復元

- **WHEN** ログイン済みユーザーがページをリロードし、`GET /tasks` でタスクデータを取得する
- **THEN** 各タスクの `is_collapsed` フィールドに基づいて折り畳み状態が復元される

#### Scenario: 未ログインユーザーの保存済み状態の復元

- **WHEN** 未ログインユーザーがアプリを起動し、localStorage にタスクデータが存在する
- **THEN** 各タスクの `isCollapsed` フィールドに基づいて折り畳み状態が復元される

#### Scenario: 保存データがない場合

- **WHEN** アプリが起動し、タスクデータに `isCollapsed` フィールドがない（旧データ、初回起動など）
- **THEN** すべてのタスクが展開された状態（`isCollapsed: false`）で表示される

### Requirement: タスク削除時の折り畳み状態クリーンアップ

タスク削除時、対象タスクの折り畳み状態もタスクと共に削除されなければならない（SHALL）。バックエンドでは CASCADE 削除により自動的に処理される。

#### Scenario: 折り畳まれたタスクの削除

- **WHEN** 折り畳み状態が true のタスクが削除される
- **THEN** そのタスクの折り畳み状態はタスクと共に削除される

#### Scenario: 子タスクを持つタスクの削除

- **WHEN** 子タスク（子孫を含む）を持つタスクが削除される
- **THEN** 削除されたタスクとその子孫すべての折り畳み状態もタスクと共に削除される
